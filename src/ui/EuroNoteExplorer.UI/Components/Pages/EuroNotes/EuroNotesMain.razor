@page "/banknotes"
@rendermode InteractiveServer
@inject IEuroNoteAPIClient EuroNoteClient

<div class="container-fluid py-4" style="color:#333;">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-1 sp-title">Eurosetelit</h2>
            <p class="text-muted">Seteleiden määrät ja arvot valitulla aikavälillä</p>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom py-3">
            <h5 class="mb-0 fw-semibold sp-title">
                <i class="bi bi-calendar-range me-2"></i>Valitse aikaväli
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Alkupäivämäärä</label>
                    <InputDate @bind-Value="Filters.StartPeriod" class="form-control form-control-lg" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Loppupäivämäärä</label>
                    <InputDate @bind-Value="Filters.EndPeriod" class="form-control form-control-lg" />
                </div>
                <div class="col-md-4">
                    <button class="btn btn-lg w-100 sp-button"
                            @onclick="GetSummary"
                            disabled="@IsLoading">
                        @if (IsLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Haetaan...</span>
                        }
                        else
                        {
                            <i class="bi bi-search me-2"></i>
                            <span>Hae tiedot</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color:var(--sp-dark-blue);" role="status"></div>
            <p class="mt-3 text-muted">Haetaan tietoja...</p>
        </div>
    }
    else if (Summaries.Any())
    {
        <div class="row g-4">
            @foreach (var summary in Summaries)
            {
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        
                        <!-- HEADER -->
                        <div class="card-header sp-card-header py-3">
                            <h4 class="mb-0 fw-bold">
                                <i class="bi bi-cash-stack me-2"></i>
                                @summary.Denomination € seteli
                            </h4>
                        </div>

                        <!-- BODY -->
                        <div class="card-body p-4">
                            <div class="row g-4">

                                <!-- SUMMARY BOX -->
                                <div class="col-md-6">
                                    <div class="rounded-3 p-4 h-100 sp-box">
                                        <h5 class="mb-3 fw-semibold sp-section-title">
                                            <i class="bi bi-bar-chart-fill me-2"></i>Yhteenveto
                                        </h5>

                                        <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
                                            <span class="text-muted">Kappalemäärä</span>
                                            <span class="fs-4 fw-bold sp-number-primary">
                                                @summary.Count.ToString("N0")
                                            </span>
                                        </div>

                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">Kokonaisarvo</span>
                                            <span class="fs-3 fw-bold sp-number-secondary">
                                                @summary.Value.ToString("N2") €
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- CURRENCY BOX -->
                                <div class="col-md-6">
                                    <div class="rounded-3 p-4 h-100 sp-box">
                                        <h5 class="mb-3 fw-semibold sp-section-title">
                                            <i class="bi bi-currency-exchange me-2"></i>Valuuttamuunnokset
                                        </h5>

                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead style="background-color:var(--sp-grey-border);">
                                                    <tr>
                                                        <th class="fw-semibold">Valuutta</th>
                                                        <th class="text-end fw-semibold">Kurssi</th>
                                                        <th class="text-end fw-semibold">Arvo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var cv in summary.CurrencyValues)
                                                    {
                                                        <tr>
                                                            <td>
                                                                <span class="badge sp-badge">@cv.CurrencyCode</span>
                                                            </td>
                                                            <td class="text-end">@cv.ExchangeRate.ToString("N4")</td>
                                                            <td class="text-end fw-semibold">@cv.Value.ToString("N2")</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert border-0 shadow-sm sp-alert" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Valitse aikaväli ja hae tiedot nähdäksesi seteliyhteenvedot.
        </div>
    }
</div>

@code {
    private BankNoteFilters Filters = new()
    {
        StartPeriod = DateTime.Today.AddDays(-7),
        EndPeriod = DateTime.Today
    };

    private IEnumerable<BankNoteSummary> Summaries = new List<BankNoteSummary>();
    private bool IsLoading = false;

    private async Task GetSummary()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            Summaries = await EuroNoteClient.GetBankNoteSummaryAsync(Filters);
        }
        finally
        {
            IsLoading = false;
        }
    }
}
